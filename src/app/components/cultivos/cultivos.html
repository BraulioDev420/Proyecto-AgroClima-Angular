<div class="cultivos-dashboard">

<!-- ğŸŒ MODAL DE SOLICITUD DE UBICACIÃ“N -->
<div *ngIf="mostrarModalUbicacion" class="modal-overlay">
  <div class="modal-ubicacion">
    <div class="modal-header">
      <h2>ğŸ“ UbicaciÃ³n del Clima</h2>
    </div>
    
    <div class="modal-body">
      <div class="ubicacion-icon">ğŸŒ</div>
      <p class="modal-mensaje">
        Â¿Deseas compartir tu ubicaciÃ³n para obtener datos climÃ¡ticos precisos de tu zona?
      </p>
      <p class="modal-submensaje">
        Esto nos permitirÃ¡ darte recomendaciones agrÃ­colas mÃ¡s precisas para tu cultivo.
      </p>
      
      <div class="modal-info">
        <div class="info-item">
          <span class="info-icon">âœ…</span>
          <span>Datos climÃ¡ticos en tiempo real</span>
        </div>
        <div class="info-item">
          <span class="info-icon">ğŸŒ±</span>
          <span>Recomendaciones personalizadas</span>
        </div>
        <div class="info-item">
          <span class="info-icon">ğŸ”’</span>
          <span>Tu ubicaciÃ³n es privada y segura</span>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-rechazar" (click)="rechazarUbicacion()">
        âŒ No, usar ubicaciÃ³n predeterminada
      </button>
      <button class="btn-aceptar" (click)="aceptarUbicacion()">
        âœ… SÃ­, compartir ubicaciÃ³n
      </button>
    </div>
  </div>
</div>

<!-- TARJETAS DE RESUMEN -->
<section class="cards">
  <div class="card">
    <div class="card-icon">ğŸŒ±</div>
    <div class="card-content">
      <h3>Total Cultivos</h3>
      <p class="card-value">{{ cultivosActivos.length }}</p>
      <span class="card-label">Activos</span>
    </div>
  </div>

  <div class="card">
    <div class="card-icon">ğŸ“</div>
    <div class="card-content">
      <h3>Ãrea Total</h3>
      <p class="card-value">{{ dashboardData?.areaTotal }} ha</p>
      <span class="card-label">HectÃ¡reas</span>
    </div>
  </div>

  <div class="card">
    <div class="card-icon">ğŸ“ˆ</div>
    <div class="card-content">
      <h3>Rendimiento</h3>
      <p class="card-value">{{ dashboardData?.rendimiento }} ton</p>
      <span class="card-label">Toneladas</span>
    </div>
  </div>

  <div class="card">
    <div class="card-icon">ğŸ’°</div>
    <div class="card-content">
      <h3>Ingresos</h3>
      <p class="card-value">${{ dashboardData?.ingresos}}</p>
      <span class="card-label">Este mes</span>
    </div>
  </div>
</section>

<!-- PANEL DE ANÃLISIS -->
<div class="dashboard-container">
  <h2>ğŸ“Š Panel de AnÃ¡lisis</h2>

  <div class="charts-grid">
    <div class="chart-card">
      <h3>Rendimiento General</h3>
      <div class="chart-wrapper">
        <canvas id="overviewChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>Comparativa de Cosechas</h3>
      <div class="chart-wrapper">
        <canvas id="yieldChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>DistribuciÃ³n por Tipo</h3>
      <div class="chart-wrapper">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- TABLA DINÃMICA DE CULTIVOS ACTIVOS -->
<section class="tabla-cultivos">
  <h2>ğŸŒ± Cultivos Activos</h2>
  
  <!-- Mensaje de carga -->
  <div *ngIf="cargando" class="mensaje-carga">
    <p>â³ Cargando cultivos...</p>
  </div>

  <!-- Mensaje si no hay cultivos -->
  <div *ngIf="!cargando && cultivosActivos.length === 0" class="mensaje-vacio">
    <p>ğŸ“­ No tienes cultivos activos registrados</p>
    <p class="submensaje">Comienza agregando tu primer cultivo</p>
  </div>

  <!-- Tabla con datos reales -->
  <div class="table-wrapper" *ngIf="!cargando && cultivosActivos.length > 0">
    <table>
      <thead>
        <tr>
          <th>Cultivo</th>
          <th>ID</th>
          <th>Fecha Siembra</th>
          <th>Estado</th>
          <th>Ãšltima actualizaciÃ³n</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cultivo of cultivosActivos">
          <td><strong>{{ cultivo.tipo_cultivo | titlecase }}</strong></td>
          <td>{{ cultivo.id_cultivo }}</td>
          <td>{{ formatearFecha(cultivo.fecha_siembra) }}</td>
          <td>
            <span [class]="'estado ' + obtenerClaseEstado(cultivo.estado)">
              {{ obtenerIconoEstado(cultivo.estado) }} {{ cultivo.estado | titlecase }}
            </span>
          </td>
          <td>{{ formatearFecha(cultivo.fecha_siembra) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- TAREAS Y CLIMA -->
<section class="extras">
  <!-- ğŸ“‹ TAREAS PREDETERMINADAS -->
  <div class="tareas">
    <h2>ğŸ§‘â€ğŸŒ¾ PrÃ³ximas Tareas</h2>
    
    <!-- Lista de tareas destacadas -->
    <ul *ngIf="tareasDestacadas.length > 0">
      <li *ngFor="let tarea of tareasDestacadas">
        <div class="tarea-info">
          <strong>{{ tarea.nombre }}</strong>
          <span class="tarea-detalles">
            {{ tarea.lote ? 'Lote ' + tarea.lote + ' - ' : '' }}{{ tarea.fecha }}
          </span>
          <span class="tarea-descripcion">{{ tarea.descripcion }}</span>
        </div>
        <span [class]="getClaseEstadoTarea(tarea.estado)">
          {{ getTextoEstado(tarea.estado) }}
        </span>
      </li>
    </ul>

    <!-- Sin tareas -->
    <div *ngIf="tareasDestacadas.length === 0" class="sin-tareas">
      <p>âœ… No hay tareas pendientes</p>
      <p class="submensaje">Agrega cultivos para ver tareas</p>
    </div>
  </div>

  <!-- ğŸŒ¤ï¸ CLIMA CON IA -->
  <div class="clima">
    <div class="clima-header-bar">
      <h2>ğŸŒ¤ï¸ Clima Actual <span class="badge-ia">ğŸ¤– IA</span></h2>
      <button 
        *ngIf="!cargandoClima" 
        class="btn-actualizar-mini"
        (click)="actualizarClima()"
        title="Actualizar clima"
      >
        ğŸ”„
      </button>
    </div>
    
    <!-- Cargando clima -->
    <div *ngIf="cargandoClima" class="loading-mini">
      <div class="spinner-small"></div>
      <p>Obteniendo clima...</p>
    </div>

    <!-- Datos del clima -->
    <div class="clima-content" *ngIf="!cargandoClima && climaActual">
      <!-- Header con icono y ubicaciÃ³n -->
      <div class="clima-principal">
        <span class="clima-icono-grande">{{ climaActual.icono }}</span>
        <div class="clima-datos-principales">
          <h3 class="clima-temperatura">{{ climaActual.temperatura }}Â°C</h3>
          <p class="clima-descripcion">{{ climaActual.descripcion }}</p>
          <p class="clima-ciudad">ğŸ“ {{ climaActual.ciudad }}</p>
        </div>
      </div>

      <!-- Detalles del clima -->
      <div class="clima-detalles">
        <div class="clima-item">
          <span class="clima-icon">ğŸ’§</span>
          <div>
            <p class="clima-label">Humedad</p>
            <p class="clima-value">{{ climaActual.humedad }}%</p>
          </div>
        </div>
        <div class="clima-item">
          <span class="clima-icon">ğŸ’¨</span>
          <div>
            <p class="clima-label">Viento</p>
            <p class="clima-value">{{ climaActual.viento }} km/h</p>
          </div>
        </div>
      </div>

      <!-- Recomendaciones de la IA -->
      <div class="clima-recomendaciones" *ngIf="climaActual.recomendaciones && climaActual.recomendaciones.length > 0">
        <h4>ğŸ’¡ Recomendaciones</h4>
        <ul>
          <li *ngFor="let rec of climaActual.recomendaciones">{{ rec }}</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <p>Â© 2025 AgroClima | Sistema de GestiÃ³n AgrÃ­cola Inteligente</p>
</footer>

</div>